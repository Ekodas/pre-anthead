[gcode_macro COLD_PULL]
description: Perform a manual cold pull on the active tool
gcode:
    # Detect active tool index
    {% set tool = printer.toolhead.extruder|replace("extruder","")|int(default=0) %}
    {% set sensor = printer.toolhead.extruder %}   ; Active tool sensor

    # Material profiles
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set materials = {
        'NYLON': {'hot_temp': 260, 'cold_temp': 50, 'pull_temp': 120, 'min_extrude_temp': 190},
        'PLA':   {'hot_temp': 250, 'cold_temp': 45, 'pull_temp': 100, 'min_extrude_temp': 160},
        'ABS':   {'hot_temp': 255, 'cold_temp': 50, 'pull_temp': 120, 'min_extrude_temp': 190},
        'PETG':  {'hot_temp': 250, 'cold_temp': 45, 'pull_temp': 100, 'min_extrude_temp': 180}
    } %}

    {% if material not in materials %}
        {action_raise_error("Unknown material. Valid: Nylon, ABS, PLA, PETG")}
    {% endif %}

    # Allow parameter overrides
    {% set hot_temp = params.HOT_TEMP|default(materials[material].hot_temp)|int %}
    {% set cold_temp = params.COLD_TEMP|default(materials[material].cold_temp)|int %}
    {% set pull_temp = params.PULL_TEMP|default(materials[material].pull_temp)|int %}
    {% set min_extrude_temp = params.MIN_EXTRUDE_TEMP|default(materials[material].min_extrude_temp)|int %}
    {% set pull_speed = params.PULL_SPEED|default(600)|int %}         ; mm/min
    {% set clean_length = params.CLEAN_LENGTH|default(25)|int %}
    {% set extrude_speed = (params.EXTRUDE_SPEED|default(1.5)|float * 60)|int %} ; mm/min

    RESPOND MSG="Starting cold pull on TOOL{tool}, material={material}"
    RESPOND MSG="hot={hot_temp}, cold={cold_temp}, pull={pull_temp}, min_extrude={min_extrude_temp}"

    # Heat to hot_temp (always 'extruder' heater)
    RESPOND MSG="Heating to {hot_temp}°C"
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={hot_temp}
    TEMPERATURE_WAIT SENSOR={sensor} MINIMUM={hot_temp-2} MAXIMUM={hot_temp+2}

    # Prime nozzle
    RESPOND MSG="Extruding {clean_length}mm to fill nozzle"
    G91
    G1 E{clean_length} F{extrude_speed} ALLOW_BYPASS=1
    G90

    # Start cooling
    RESPOND MSG="Cooling to {cold_temp}°C"
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cold_temp}
    M106 S255

    {% for temp in range(hot_temp, cold_temp, -10) %}
        {% if temp > min_extrude_temp %}
            TEMPERATURE_WAIT SENSOR={sensor} MAXIMUM={temp}
            RESPOND MSG="Stuffing nozzle at {temp}°C"
            G91
            G1 E1 F{extrude_speed} ALLOW_BYPASS=1
            G90
        {% endif %}
    {% endfor %}

    TEMPERATURE_WAIT SENSOR={sensor} MAXIMUM={cold_temp}
    RESPOND MSG="Reached cold temp ({cold_temp}°C)"

    # Rewarm to pull temp
    M107
    RESPOND MSG="Re-heating to pull temp: {pull_temp}°C"
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={pull_temp}
    TEMPERATURE_WAIT SENSOR={sensor} MINIMUM={pull_temp}

    RESPOND MSG=">>> PULL NOW on TOOL{tool} <<<"
    G91
    G1 E-150 F{pull_speed} ALLOW_BYPASS=1
    G90

    RESPOND MSG="Cold pull done on TOOL{tool}. Inspect filament end for nozzle shape."
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
