[gcode_macro COLD_PULL]
description: Perform a manual cold pull (Happy Hare–free version)
gcode:
    {% set material = params.MATERIAL|default("PLA")|string|upper %}
    {% set materials = {
        'NYLON': {'hot_temp': 260, 'cold_temp': 50, 'pull_temp': 120, 'min_extrude_temp': 190},
        'PLA':   {'hot_temp': 250, 'cold_temp': 45, 'pull_temp': 100, 'min_extrude_temp': 160},
        'ABS':   {'hot_temp': 255, 'cold_temp': 50, 'pull_temp': 120, 'min_extrude_temp': 190},
        'PETG':  {'hot_temp': 250, 'cold_temp': 45, 'pull_temp': 100, 'min_extrude_temp': 180}
    } %}
    {% if material not in materials %}
        {action_raise_error("Unknown material. Valid: Nylon, ABS, PLA, PETG")}
    {% endif %}

    # Allow overrides
    {% set hot_temp = params.HOT_TEMP|default(materials[material].hot_temp)|int %}
    {% set cold_temp = params.COLD_TEMP|default(materials[material].cold_temp)|int %}
    {% set pull_temp = params.PULL_TEMP|default(materials[material].pull_temp)|int %}
    {% set min_extrude_temp = params.MIN_EXTRUDE_TEMP|default(materials[material].min_extrude_temp)|int %}
    {% set pull_speed = params.PULL_SPEED|default(600)|int %}         ; mm/min
    {% set clean_length = params.CLEAN_LENGTH|default(25)|int %}
    {% set extrude_speed = (params.EXTRUDE_SPEED|default(1.5)|float * 60)|int %} ; mm/min

    {% set msg1 = "Starting cold pull with profile: " ~ material %}
    {% set msg2 = "hot=%d, cold=%d, pull=%d, min_extrude=%d" % (hot_temp, cold_temp, pull_temp, min_extrude_temp) %}

    RESPOND MSG="{msg1}"
    RESPOND MSG="{msg2}"

    # Heat to hot_temp
    RESPOND MSG="Heating to %d°C" % hot_temp
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={hot_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={hot_temp-2} MAXIMUM={hot_temp+2}

    # Prime nozzle
    RESPOND MSG="Extruding %dmm to fill nozzle" % clean_length
    G91
    G1 E{clean_length} F{extrude_speed}
    G90

    # Start cooling
    RESPOND MSG="Cooling to %d°C" % cold_temp
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={cold_temp}
    M106 S255

    {% for temp in range(hot_temp, cold_temp, -10) %}
        {% if temp > min_extrude_temp %}
            TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={temp}
            {% set stuff_msg = "Stuffing nozzle at %d°C" % temp %}
            RESPOND MSG="{stuff_msg}"
            G91
            G1 E1 F{extrude_speed}
            G90
        {% endif %}
    {% endfor %}

    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={cold_temp}
    RESPOND MSG="Reached cold temp (%d°C)" % cold_temp

    # Rewarm to pull temp
    M107
    RESPOND MSG="Re-heating to pull temp: %d°C" % pull_temp
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={pull_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={pull_temp}

    RESPOND MSG=">>> PULL NOW <<<"
    G91
    G1 E-150 F{pull_speed}
    G90

    RESPOND MSG="Cold pull done. Inspect filament end for nozzle shape."
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
